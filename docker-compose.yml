services:
  # 1. Identity Servisi
  identity-service:
    build: ./identity-service
    container_name: identity_container
    ports:
      - "8000:8000"
    networks:
      - exam-network
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/examdb

  # 2. Exam Servisi
  exam-service:
    build: ./exam-service
    container_name: exam_container
    ports:
      - "8001:8000"
    networks:
      - exam-network
    depends_on:
      - db
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/examdb

  # 3. VeritabanÄ±
  db:
    image: postgres:15
    container_name: postgres_db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: examdb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - exam-network

  # 4. YENÄ°: RabbitMQ (Mesaj KuyruÄŸu) ğŸ°
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq_server
    ports:
      - "5672:5672"   # Servislerin konuÅŸacaÄŸÄ± port
      - "15672:15672" # Senin tarayÄ±cÄ±dan gÃ¶receÄŸin panel
    networks:
      - exam-network


  # 5. YENÄ°: Submit Service (Producer)
  submit-service:
    build: ./submit-service
    container_name: submit_container
    ports:
      - "8002:8000"
    networks:
      - exam-network
    depends_on:
      - rabbitmq
    # RabbitMQ hemen acilmayabilir, bu kod servisin Ã§Ã¶kmesini engeller, tekrar dener
    restart: always

    # 6. YENÄ°: Grading Service (Consumer / Worker)
  grading-service:
    build: ./grading-service
    container_name: grading_worker
    networks:
      - exam-network
    depends_on:
      - rabbitmq
    restart: always  # RabbitMQ hazÄ±r deÄŸilse Ã§Ã¶kmesin, tekrar denesin

networks:
  exam-network:
    driver: bridge

volumes:
  postgres_data: